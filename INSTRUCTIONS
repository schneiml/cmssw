# Setup DQMStore patch

cd /dev/shm/$USER/
cmsrel CMSSW_11_0_0_pre5
cd CMSSW_11_0_0_pre5/src
cmsenv
git cms-merge-topic schneiml:dqm-booking-popularity
scram b -j16 # ~30min

# Run the short matrix to get booking logs

runTheMatrix.py -l limited --command '-n 1' --ibeos -j8 # ~1h

# Parse logs into SQLite db

grep -nR DQMStore::book *.*_* | awk '
  BEGIN { 
    print("CREATE TABLE IF NOT EXISTS Booking(wf, step, type, module, path); BEGIN;") 
  }
  match($0, /([0-9]+[.][0-9]+)[^\/]*\/step(.)[^:]*:[0-9]+:([^ ]+) ([^ ]*) (.*)$/, a) { 
    print("INSERT INTO Booking(wf, step, type, module, path) VALUES(" a[1] ", " a[2] ", \x22" a[3] "\x22, \x22" a[4] "\x22, \x22" a[5] "\x22);" )
  } 
  END { 
    print("COMMIT;") 
  }
' | sqlite3 booking.db

# On the DQMGUI server, parse the old access logs

for f in /data/srv/logs/dqmgui/offline/old-logs-2018*.zip; do 
  unzip -p $f weblog-* | grep 'fairy' | gawk '
    BEGIN { 
      print("CREATE TABLE IF NOT EXISTS Access(dataset, path, who); BEGIN;") 
    } 
    match($0, /obj=archive%2F[0-9]+%2F([^%]+%2F[^%]+%2F[^%]+)%2F([^;]+);.*auth: OK "([^"]*)"/, a) { 
      gsub(/%2F/, "/", a[1]); 
      gsub(/%2F/, "/", a[2]); 
      gsub(/%22/, " ", a[2]); 
      print("INSERT INTO Access(dataset, path, who) VALUES(\x22" a[1] "\x22, \x22" a[2] "\x22, \x22" a[3] "\x22);" ) 
    } 
    END { 
      print("COMMIT;")
    }
  ' | sqlite3 access.db
done


# do some analysis
sqlite3 booking.db
 CERATE INDEX metomod ON Booking(path);

sqlite3 access.db
 ATTACH "booking.db" as booking;
 SELECT sum(views), module FROM (
   -- pre-group views per ME to keep the number of rows down
   SELECT count(*) as views, path FROM Access GROUP BY path
 ) NATURAL JOIN (
   -- pre-group bookings to prevent double counting, suppress
   -- (unset) from reading DQMIO (probably?) and MEtoEDM IO.
   SELECT DISTINCT path, module FROM Booking WHERE module not in ("(unset)", "EDMtoMEConverter")
 )
 GROUP BY module ORDER BY 1 DESC;


# Result:
#
sum(views)      module
825784  JetAnalyzer
666842  SiStripMonitorTrack
658608  TrackingMonitor
491834  SiPixelPhase1TrackClusters
440580  MuonRecoAnalyzer
424184  SiPixelPhase1Clusters
392198  MonitorTrackResiduals
353941  METAnalyzer
318910  SiPixelPhase1Digis
224059  CSCOfflineMonitor
178597  DQMGenericClient
178442  SiStripMonitorCluster
146469  SiStripFEDMonitorPlugin
135815  MuonKinVsEtaAnalyzer
134705  ElectronAnalyzer
77108   SiPixelPhase1Harvester
74265   JetAnalyzer_HeavyIons
63678   PrimaryVertexMonitor
60003   SiStripOfflineDQM
53993   SiPixelPhase1TrackEfficiency
44601   SiPixelPhase1Summary
33584   DQMPFCandidateAnalyzer
31534   DQMDcsInfoClient
28223   L1TStage2CaloLayer2Offline
23770   SiStripMonitorDigi
22782   DiMuonHistograms
21125   SiPixelPhase1RawData
18128   L1TMuonDQMOffline
17983   DQMFileSaver
17163   SiPixelPhase1RecHits
17117   SiPixelPhase1TrackResiduals
16597   CSCMonitorModule
14477   TauTagValidation
14459   RPCMonitorDigi
13175   TrackingOfflineDQM
11887   RPCDqmClient
10981   L1TTauOffline
10578   L1TEGammaOffline
8676    DQMDcsInfo
8207    PrimaryVertexResolution
5779    ElectronOfflineClient
5713    V0Monitor
5193    RPCChamberQuality
3323    EfficiencyPlotter
3291    TauDQMHistEffProducer
3201    ElectronTagProbeAnalyzer
2514    SiStripGainsPCLHarvester
2249    SiPixelTrackResidualSource
2122    SiPixelEDAClient
1881    BTagPerformanceAnalyzerOnData
1651    DQMEventInfo
1631    SiPixelMonitorTrackResiduals
1514    MuonIsolationDQM
1366    CentralityDQM
1362    MuonIdDQM
1264    TrackingRecoMaterialAnalyser
1195    EcalDQMonitorTask
1157    TrackEfficiencyMonitor
1074    L1TStage2EMTF
895     HLTMuonOfflineAnalyzer
847     RPCEfficiencySecond
705     MillePedeDQMModule
700     MuonSeedsAnalyzer
688     DataCertificationJetMET
651     L1TStage2uGMT
562     DigiTask
512     RecHitTask
488     DTResolutionAnalysisTest
419     DQMMessageLogger
404     TrackEfficiencyClient
389     ZToMuMuGammaAnalyzer
370     PhotonAnalyzer
350     HcalRecHitsAnalyzer
350     SiStripGainsPCLWorker
344     GeneralHLTOffline
322     DQMMessageLoggerClient
276     SiPixelDigiSource
263     TopMonitor
256     SiPixelClusterSource
252     EfficiencyAnalyzer
231     L1TStage2RegionalMuonCandComp
227     HiggsDQM
223     DTSegmentAnalysisTest
219     dEdxAnalyzer
217     SiStripDaqInfo
214     TkAlCaRecoMonitor
206     RPCEfficiencyShiftHisto
205     TopDiLeptonOfflineDQM
201     MuonRecoOneHLT
192     DTChamberEfficiencyClient
184     SiStripCertificationInfo
166     AlcaBeamMonitor
154     PhotonOfflineClient
150     HcalOfflineHarvesting
134     DTRunConditionVarClient
133     RPCEventSummary
132     TPTask
131     RPCFEDIntegrity
126     SiStripDcsInfo
125     RPCDcsInfoClient
120     TrackSplittingMonitor
117     SiStripFEDCheckPlugin
101     LogMessageMonitor
100     L1TEventInfoClient
100     RPCRecHitProbability
95      ExoticaDQM
89      METMonitor
88      RawTask
87      PiZeroAnalyzer
84      ElectronGeneralAnalyzer
79      DQMScaleToClient
74      TopSingleLeptonDQM
72      HLTObjectsMonitor
72      SingleTopTChannelLeptonDQM
70      L1TObjectsTiming
70      RPCEfficiency
62      L1TStage2OMTF
62      MuonTestSummary
60      PFClient_JetRes
58      SUSYDQMAnalyzer
57      MuonEnergyDepositAnalyzer
55      DTDataIntegrityTask
55      JetMETHLTOfflineSource
54      SegmentTrackAnalyzer
52      L1TStage2CaloLayer2
46      L1TdeStage2EMTF
45      L1TStage2BMTF
42      TrackingCertificationInfo
40      DTSegmentAnalysisTask
40      SusyPostProcessor
33      BTagPerformanceHarvester
32      DTResolutionAnalysisTask
31      DQMFEDIntegrityClient
31      DTSegmentsTask
30      BPhysicsOniaDQM
28      MuonPFAnalyzer
26      DTDCSByLumiSummary
25      CSCDcsInfo
24      PhotonDataCertification
21      L1TStage2uGMTMuon
20      DQMOfflineHLTEventInfoClient
20      DTRunConditionVar
16      ESDaqInfoTask
16      dEdxHitAnalyzer
12      DTBlockedROChannelsTest
12      SiPixelDaqInfo
12      SiPixelDcsInfo
12      SiPixelHitEfficiencySource
10      DTDCSByLumiTask
10      DTTriggerEfficiencyTest
10      L1TStage2CaloLayer1
10      MuonRecoTest
10      MuonTrackResidualsTest
9       EcalFEDMonitor
9       SiStripBadComponentInfo
8       LumiMonitor
5       CastorMonitorModule
4       DTCertificationSummary
4       DTDAQInfo
4       DTOfflineSummaryClients
4       HTMonitor
4       L1TStage2RatioClient
2       RecoSusyDQM
1       CSCCertificationInfo
1       CSCDaqInfo
1       CSCOfflineClient

