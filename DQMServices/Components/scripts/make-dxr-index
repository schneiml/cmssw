report () {
      echo "$@" 1>&2
      "$@"
}

report cd $CMSSW_BASE/src/DQMServices/Components/scripts
CLANG=$(which clang++)
CLANGINC="${CLANG%/bin/clang++}/include/"

report clang++ sha1.cpp dxr-index.cpp -o dxr-index.so --shared -fPIC -I "$CLANGINC" -O2

report cd $CMSSW_BASE/
# touch a lot  of files to trigger a full recompile
touch $(find src/ -name '*.cc' )

# run scram b with indexer active
PLUGIN="-Xclang -load -Xclang $PWD/src/DQMServices/Components/scripts/dxr-index.so -Xclang -plugin -Xclang dxr-index  -Xclang -plugin-arg-dxr-index -Xclang $PWD/src"
echo PLUGIN=$PLUGIN
USER_CXXFLAGS="$PLUGIN" report scram build -k  -j8 

report cd $CMSSW_BASE/src/
report bash DQMServices/Components/scripts/csv_to_sqlite.sh

echo "Check $PWD/dxr.sqlite for your DXR index database."

