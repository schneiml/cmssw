DB="sqlite3 dxr.sqlite"
$DB <<SQL
.load /build/schneiml/newdqmstore/CMSSW_10_6_CLANG_X_2019-04-16-2300/src/DQMServices/Components/scripts/pcre.so

CREATE  TABLE unused AS 
  SELECT variable.loc AS loc
  FROM variable INNER JOIN code ON code.loc=variable.loc 
  WHERE 
    variable.type LIKE "DQMStore %" and (
      SELECT count(*) FROM ref INNER JOIN code ON code.loc = ref.loc 
      WHERE ref.defloc = variable.loc 
        and code.line NOT REGEXP (variable.name || "\s*=")
    ) < 1
;
CREATE  TABLE unusedrefs AS 
  SELECT loc
  FROM ref 
  WHERE ref.defloc IN unused
;
SQL

for f in $(echo 'SELECT DISTINCT rtrim(loc, "0123456789:") FROM (SELECT * FROM unused UNION SELECT * FROM unusedrefs);' | $DB); do
  $DB <<SQL > $f
  SELECT line FROM code 
  WHERE rtrim(loc, "0123456789:") = "$f" 
    and loc not in unused 
    and loc not in unusedrefs;
SQL
done
