DB="sqlite3 dxr.sqlite"
$DB <<SQL
.load /build/schneiml/newdqmstore/CMSSW_10_6_CLANG_X_2019-04-16-2300/src/DQMServices/Components/scripts/pcre.so
CREATE TABLE dqmstores AS 
  SELECT DISTINCT code.* 
  FROM variable NATURAL JOIN code 
  WHERE variable.type LIKE "DQMStore %" and variable.loc NOT IN (
    SELECT loc FROM function
  )
;
CREATE TABLE edmservices AS 
  SELECT DISTINCT loc, line from ref NATURAL JOIN code 
  WHERE qualname = "edm::Service" and line REGEXP "\bDQMStore\b"
;

CREATE TABLE problematic AS 
  SELECT * FROM edmservices 
  WHERE  rtrim(loc, "1234567890:") in (SELECT rtrim(loc, "1234567890:") FROM edmservices GROUP BY 1 HAVING count(*) > 1)
;

DELETE FROM edmservices WHERE loc IN (SELECT loc FROM problematic);

SQL

for f in $(echo 'SELECT DISTINCT rtrim(loc, "0123456789:") FROM (SELECT loc FROM dqmstores UNION SELECT loc FROM edmservices);' | $DB); do
  $DB <<SQL > $f
.load /build/schneiml/newdqmstore/CMSSW_10_6_CLANG_X_2019-04-16-2300/src/DQMServices/Components/scripts/glib_replace.so
  SELECT CASE 
    WHEN loc IN (SELECT loc FROM edmservices) AND loc IN (SELECT loc FROM dqmstores) THEN
       regex_replace("DQMStore\s*[*]\s*(\w+)\s*?=[*& \t]*(edm::)?Service\s*<\s*DQMStore\s*>.*;", line, "std::unique_ptr<DQMStore> \1 = std::make_unique<DQMStore>();")
    WHEN loc IN (SELECT loc FROM edmservices) THEN
       regex_replace("=[*& \t]*(edm::)?Service\s*<\s*DQMStore\s*>.*;", line, "= std::make_unique<DQMStore>();")
    WHEN loc IN (SELECT loc FROM dqmstores) THEN 
       regex_replace("DQMStore\s*[*]\s*(\w+)\s*?( ?[;=])", line, "std::unique_ptr<DQMStore> \1\2")
    ELSE line END 
  FROM code 
  WHERE rtrim(loc, "0123456789:") = "$f";
SQL
done
